---

- name: install | consul agent | Check agent archive stat
  stat: 
    path="{{ consul_tmp_dir }}/{{ consul_agent_archive }}"
  register: consul_agent_archive_stat

- name: install | consul agent | Download consul agent (if needed)
  get_url:
    url="{{ consul_agent_download_url }}"
    dest="{{ consul_tmp_dir }}"
  become_user: "{{ consul_user }}"
  register: consul_agent_get
  when: consul_agent_archive_stat.stat.exists == False

- name: install | consul agent | Unpack consul arcive (if needed)
  unarchive:
    src="{{ consul_tmp_dir }}/{{ consul_agent_archive }}"
    dest="{{ consul_bin_dir }}"
    copy="no"
  become_user: "{{ consul_user }}"
  when: consul_agent_get | changed
  notify:
    - restart consul service

- name: install | consul agent | Ensure consul configure is deployed
  template: 
    src="{{ path_for_template }}consul_agent.json.j2"
    dest="{{ consul_config_file }}"
    owner="{{ consul_user }}"
    group="{{ consul_group }}"
    mode="0640"
  notify:
    - restart consul service

- name: install | consul agent | Ensure consul run script is deployed
  template: 
    src="{{ path_for_template }}consul_agent_run.sh.j2"
    dest="{{ consul_bin_dir }}/consul_agent_run.sh"
    owner="{{ consul_user }}"
    group="{{ consul_group }}"
    mode="0755"
  notify:
    - restart consul service

# TODO Support runnit
- name: install | consul agent | Ensure consul init.d script is deployed
  template: 
    src="{{ path_for_template }}consul-init.d.sh.j2"
    dest=/etc/init.d/consul
    owner="{{ consul_user }}"
    group="{{ consul_group }}"
    mode="0755"
  notify:
    - restart consul service
