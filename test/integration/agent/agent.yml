---

- name: agent
  hosts: all
  become: True
  vars:
    consul_server               : True
    consul_bootstrap_expect     : 1
    consul_ui                   : false

    consul_services       :
      google              :
        name              : "google"
        port              : 80
        address           : "www.google.com"
        check             : 
            script        : "curl http://www.google.com > /dev/null"
            interval      : "120s"
        haproxy           :
          server_options  : "check inter 120s fastinter 5s downinter 8s rise 3 fall 2"
          service_mode    : "http"

      superssh            :
        name              : "superssh"
        tags              : 
                             - "test"
        port              : 22
        local_port        : 2222
        check             : 
            script        : "netstat -ltnp | grep ':22 ' > /dev/null 2>&1"
            interval      : "10s"
        haproxy           :
          server_options  : "check inter 10s fastinter 5s downinter 8s rise 3 fall 2"
          service_mode    : "tcp"

      superdb             :
        name              : "superdb"
        tags              : 
                             - "test"
        port              : 5431
        check             : 
            script        : "curl localhost:5432 > /dev/null 2>&1"
            interval      : "10s"
        haproxy           :
          server_options  : "check inter 10s fastinter 5s downinter 8s rise 3 fall 2"
          service_mode    : "tcp"

    consul_producer             : True
    consul_producer_services    : [ 'superssh', 'google' ]

    consul_consumer             : True
    consul_consumer_services    : [ 'superdb','superssh', "google" ]

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache=yes
        cache_valid_time=360

  roles :
    - ansible-consul